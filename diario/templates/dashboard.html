<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Di√°rio Pessoal</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Caveat', cursive;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 15px;
            color: #e0e0e0;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .titulo {
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .subtitulo {
            font-size: 18px;
            color: #b0b0b0;
        }

        .btn-voltar {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Caveat', cursive;
            margin-bottom: 20px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-voltar:hover {
            background: #5568d3;
        }

        /* Filtros de Per√≠odo */
        .filtros-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn-filtro {
            background: #2d2d2d;
            color: #e0e0e0;
            border: 2px solid #444;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Caveat', cursive;
            transition: all 0.3s;
        }

        .btn-filtro.ativo {
            background: #667eea;
            border-color: #667eea;
            color: white;
            font-weight: bold;
        }

        .btn-filtro:hover {
            border-color: #667eea;
        }

        /* Cards de Estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .stat-numero {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 16px;
            color: #b0b0b0;
        }

        /* Gr√°fico */
        .grafico-container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .grafico-titulo {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 24px;
            color: #667eea;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        /* Responsivo Desktop */
        @media (min-width: 768px) {
            body {
                padding: 30px;
            }

            .titulo {
                font-size: 48px;
            }

            .subtitulo {
                font-size: 22px;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-numero {
                font-size: 40px;
            }

            .stat-label {
                font-size: 18px;
            }

            .filtros-container {
                gap: 12px;
                margin-bottom: 30px;
            }

            .btn-filtro {
                padding: 12px 24px;
                font-size: 18px;
            }

            .chart-wrapper {
                height: 400px;
            }

            .grafico-container {
                padding: 30px;
            }

            .grafico-titulo {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <a href="/" class="btn-voltar">‚Üê Voltar ao Di√°rio</a>
            <div class="titulo">üìä Dashboard</div>
            <div class="subtitulo">Estat√≠sticas das suas tarefas</div>
        </div>

        <!-- Filtros de Per√≠odo -->
        <div class="filtros-container">
            <button class="btn-filtro ativo" onclick="trocarPeriodo(7)">7 dias</button>
            <button class="btn-filtro" onclick="trocarPeriodo(14)">14 dias</button>
            <button class="btn-filtro" onclick="trocarPeriodo(30)">30 dias</button>
            <button class="btn-filtro" onclick="trocarPeriodo(90)">90 dias</button>
            <button class="btn-filtro" onclick="trocarPeriodo(365)">365 dias</button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">Carregando dados...</div>

        <!-- Error -->
        <div id="error" class="error" style="display: none;"></div>

        <!-- Cards de Estat√≠sticas -->
        <div id="stats" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-numero" id="stat-total">0</div>
                <div class="stat-label">Total de Tarefas</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-media">0</div>
                <div class="stat-label">M√©dia Di√°ria</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-pico">0</div>
                <div class="stat-label">Recorde</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero" id="stat-ativos">0%</div>
                <div class="stat-label">Dias Ativos</div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div id="grafico" class="grafico-container" style="display: none;">
            <div class="grafico-titulo">Tarefas ao Longo do Tempo</div>
            <div class="chart-wrapper">
                <canvas id="chart-tarefas"></canvas>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let periodoAtual = 7;

        // Carregar dados da API
        async function carregarDados(periodo) {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('grafico').style.display = 'none';

                const response = await fetch(`/api/diario/metricas/?periodo=${periodo}`);

                if (!response.ok) {
                    throw new Error('Erro ao carregar dados');
                }

                const dados = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (dados.data && dados.data.length > 0) {
                    processarDados(dados.data);
                    document.getElementById('stats').style.display = 'grid';
                    document.getElementById('grafico').style.display = 'block';
                } else {
                    mostrarErro('Nenhum dado encontrado para este per√≠odo');
                }

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').style.display = 'none';
                mostrarErro('Erro ao carregar dados. Tente novamente.');
            }
        }

        // Processar dados e atualizar dashboard
        function processarDados(data) {
            // Inverter para ordem cronol√≥gica
            const dadosOrdenados = [...data].reverse();

            // Calcular estat√≠sticas
            const quantidades = data.map(d => d.quantidade);
            const total = quantidades.reduce((sum, q) => sum + q, 0);
            const media = (total / quantidades.length).toFixed(1);
            const pico = Math.max(...quantidades);
            const diasAtivos = quantidades.filter(q => q > 0).length;
            const taxaAtivos = ((diasAtivos / quantidades.length) * 100).toFixed(0);

            // Atualizar cards
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-media').textContent = media;
            document.getElementById('stat-pico').textContent = pico;
            document.getElementById('stat-ativos').textContent = taxaAtivos + '%';

            // Criar gr√°fico
            criarGrafico(dadosOrdenados);
        }

        // Criar gr√°fico com Chart.js
        function criarGrafico(dados) {
            const ctx = document.getElementById('chart-tarefas').getContext('2d');

            // Destruir gr√°fico anterior se existir
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Preparar dados
            const labels = dados.map(d => d.date.substring(0, 5)); // dd/mm
            const valores = dados.map(d => d.quantidade);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tarefas',
                        data: valores,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1e1e1e',
                            titleColor: '#fff',
                            bodyColor: '#e0e0e0',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return dados[index].date;
                                },
                                label: function(context) {
                                    const valor = context.parsed.y;
                                    return valor === 1 ? '1 tarefa' : `${valor} tarefas`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    family: 'Caveat',
                                    size: 14
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#b0b0b0',
                                stepSize: 1,
                                font: {
                                    family: 'Caveat',
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // Trocar per√≠odo
        function trocarPeriodo(periodo) {
            periodoAtual = periodo;

            // Atualizar bot√µes
            document.querySelectorAll('.btn-filtro').forEach(btn => {
                btn.classList.remove('ativo');
            });
            event.target.classList.add('ativo');

            // Carregar novos dados
            carregarDados(periodo);
        }

        // Mostrar erro
        function mostrarErro(mensagem) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = mensagem;
            errorDiv.style.display = 'block';
        }

        // Inicializar ao carregar a p√°gina
        carregarDados(7);
    </script>
</body>
</html>